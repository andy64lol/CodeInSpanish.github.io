<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pitón IDE</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="container">
    <div class="editor-pane">
      <div class="editor-header">
        <span id="editorHeader">main.ptn</span>
      </div>
      <div class="editor-content">
        <div class="line-numbers" id="lineNumbers"></div>
        <textarea id="editor" spellcheck="false">funcion factorial(n):
    si n == 0 entonces:
        retornar 1
    sino:
        retornar n * factorial(n - 1)
    fin si
fin funcion

imprimir("Factorial de 5:", factorial(5))</textarea>
      </div>
    </div>
    <div class="preview-pane">
      <div class="preview-header">
        <span id="previewHeader">Python Code</span>
      </div>
      <pre id="preview"></pre>
    </div>
  </div>
  <div class="buttons">
    <button id="convertButton">Convertir a Python</button>
    <button id="saveNativeButton">Guardar .ptn</button>
    <button id="saveConvertedButton">Guardar .py</button>
   <a href="index.html"><button>Volver</button></a>
    <button id="loadButton">Cargar</button>
  </div>
  <input type="file" id="fileInput" style="display:none" />
  <script>
    function convertirPitonAPython(codigo) {
  // Normalize line endings and trim the code
  let pythonCode = codigo.replace(/\r\n/g, '\n').trim();

  // Handle function definitions
  pythonCode = pythonCode.replace(/(\n|^)\s*funcion\s+(\w+)\s*\(([^)]*)\)\s*:/g, (match, p1, p2, p3) => {
    return `${p1}def ${p2}(${p3}):`;
  });

  // Handle if, elif, and else statements
  pythonCode = pythonCode.replace(/si\s+(.*?)\s+entonces:/g, 'if $1:');
  pythonCode = pythonCode.replace(/sino\s+si\s+(.*?)\s+entonces:/g, 'elif $1:');
  pythonCode = pythonCode.replace(/sino:/g, 'else:');

  // Handle loops
  pythonCode = pythonCode.replace(/para\s+(.*?)\s+en\s+(.*?)\s+hacer:/g, 'for $1 in $2:');
  pythonCode = pythonCode.replace(/mientras\s+(.*?)\s+hacer:/g, 'while $1:');

  // Handle print statements
  pythonCode = pythonCode.replace(/imprimir\((.*)\)/g, 'print($1)');

  // Handle return statements
  pythonCode = pythonCode.replace(/retornar/g, 'return');

  // Handle logical operators and keywords
  const replacements = {
    'no es': 'is not',
    'es': 'is',
    'verdadero': 'True',
    'falso': 'False',
    'nulo': 'None',
    'y': 'and',
    'o': 'or',
    'no': 'not',
    'lista': 'list',
    'tupla': 'tuple',
    'conjunto': 'set',
    'diccionario': 'dict',
    'longitud': 'len',
    'rango': 'range',
    'iterar': 'iter',
    'siguiente': 'next'
  };

 
  const orderedKeys = [
    'no es', 'es', 'verdadero', 'falso', 'nulo', 'y', 'o', 'no',
    'lista', 'tupla', 'conjunto', 'diccionario', 'longitud', 'rango', 'iterar', 'siguiente'
  ];

  orderedKeys.forEach(key => {
    const regex = new RegExp(`\\b${key}\\b`, 'g');
    pythonCode = pythonCode.replace(regex, replacements[key]);
  });


  pythonCode = pythonCode.replace(/(\n|^)\s*fin(\s+\w+)?/g, '');


  pythonCode = pythonCode.replace(/(\n)(\s*)/g, (match, p1, p2) => {
    const indentLevel = p2.length / 2;
    return `${p1}${'  '.repeat(indentLevel)}`;
  });


  pythonCode = pythonCode.replace(/\s+:/g, ':');
  pythonCode = pythonCode.replace(/(\n){3,}/g, '\n\n');

  return pythonCode.trim();
}
 
const editor = document.getElementById('editor');
const preview = document.getElementById('preview');
const convertButton = document.getElementById('convertButton');
const saveNativeButton = document.getElementById('saveNativeButton');
const saveConvertedButton = document.getElementById('saveConvertedButton');
const invertButton = document.getElementById('invertButton');
const backButton = document.getElementById('backButton');
const loadButton = document.getElementById('loadButton');
const fileInput = document.getElementById('fileInput');

let currentMode = "ptn";

function updateLineNumbers() {
  const lines = editor.value.split('\n').length;
  document.getElementById('lineNumbers').innerHTML = Array(lines)
    .fill()
    .map((_, i) => i + 1)
    .join('<br>');
}

function convertCode() {
  preview.textContent = currentMode === "ptn" 
    ? convertirPitonAPython(editor.value)
    : convertirPythonAPiton(editor.value);
}

function saveFile(extension) {
  const content = extension === (currentMode === "ptn" ? "ptn" : "py")
    ? editor.value
    : preview.textContent;
  
  const blob = new Blob([content], { type: 'text/plain' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `main.${extension}`;
  a.click();
  URL.revokeObjectURL(url);
}

function updateUI() {
  document.getElementById('editorHeader').textContent = 
    `main.${currentMode === "ptn" ? "ptn" : "py"}`;
    
  document.getElementById('previewHeader').textContent = 
    `${currentMode === "ptn" ? "Python" : "Pitón"} Code`;
    
  convertButton.textContent = 
    `Convertir a ${currentMode === "ptn" ? "Python" : "Pitón"}`;
    
  saveNativeButton.textContent = 
    `Guardar .${currentMode === "ptn" ? "ptn" : "py"}`;
    
  saveConvertedButton.textContent = 
    `Guardar .${currentMode === "ptn" ? "py" : "ptn"}`;
}

function invertConversion() {
  currentMode = currentMode === "ptn" ? "py" : "ptn";
  [editor.value, preview.textContent] = [preview.textContent, editor.value];
  updateUI();
  updateLineNumbers();
}

function handleFile(file) {
  const reader = new FileReader();
  reader.onload = (e) => {
    editor.value = e.target.result;
    currentMode = file.name.endsWith('.ptn') ? 'ptn' : 'py';
    updateUI();
    convertCode();
    updateLineNumbers();
  };
  reader.readAsText(file);
}

editor.addEventListener('input', updateLineNumbers);
convertButton.addEventListener('click', convertCode);
saveNativeButton.addEventListener('click', () => saveFile(currentMode === "ptn" ? "ptn" : "py"));
saveConvertedButton.addEventListener('click', () => saveFile(currentMode === "ptn" ? "py" : "ptn"));
invertButton.addEventListener('click', invertConversion);
backButton.addEventListener('click', () => window.location.href = 'index.html');
loadButton.addEventListener('click', () => fileInput.click());
fileInput.addEventListener('change', (e) => {
  const file = e.target.files[0];
  if (file) handleFile(file);
});

updateUI();
updateLineNumbers();
convertCode();
  </script>
</body>
</html>
